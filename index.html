<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N칩mina Final - Compacta</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 shadow-lg rounded-lg">
        
        <div class="border-b pb-4 mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Control de N칩mina</h1>
                <p class="text-gray-500 text-sm">Lunes-Viernes (7-4) | <span class="text-blue-600 font-bold">S치bados (7-12)</span></p>
            </div>
            <div class="text-right flex flex-col items-end gap-1">
                <div class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded text-xs font-bold border border-yellow-200">
                    Almuerzo (L-V): 12:00 - 01:00
                </div>
                <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-xs font-bold border border-blue-200">
                    S치bados: Salida 12:00 PM
                </div>
            </div>
        </div>

        <div class="mb-6 bg-blue-50 p-4 rounded border border-blue-200 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div class="md:col-span-2">
                <label class="block text-gray-700 font-bold mb-2">Nombre del Trabajador:</label>
                <input type="text" id="inputNombre" class="w-full border border-gray-300 p-2 rounded text-lg uppercase focus:ring focus:ring-blue-300" placeholder="Ej: JUAN P칄REZ">
            </div>
            <div>
                <label class="block text-gray-700 font-bold mb-2">Pago Hora Extra ($):</label>
                <input type="number" id="inputTarifaExtra" class="w-full border border-gray-300 p-2 rounded text-lg font-bold text-green-700" value="3.00" step="0.50">
            </div>
            <div>
                <label class="block text-gray-700 font-bold mb-2 text-red-600">Adelanto/Anticipo ($):</label>
                <input type="number" id="inputAdelanto" class="w-full border border-red-300 p-2 rounded text-lg font-bold text-red-600 focus:ring focus:ring-red-300" value="0" min="0" oninput="renderizarTabla()">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6 items-end bg-gray-50 p-4 rounded border">
            <div class="col-span-1 md:col-span-2">
                <label class="block text-xs font-bold mb-1">Fecha</label>
                <input type="date" id="inputFecha" class="w-full border p-2 rounded" onchange="detectarSabado()">
            </div>
            <div>
                <label class="block text-xs font-bold mb-1">Entrada</label>
                <input type="time" id="inputEntrada" class="w-full border p-2 rounded" value="07:00">
            </div>
            <div>
                <label class="block text-xs font-bold mb-1">Salida</label>
                <input type="time" id="inputSalida" class="w-full border p-2 rounded" value="16:00">
            </div>
            <div>
                <label class="block text-xs font-bold mb-1">Sueldo Diario ($)</label>
                <input type="number" id="inputSueldo" class="w-full border p-2 rounded" placeholder="20" value="20">
            </div>
            <div>
                <button type="button" onclick="agregarFila()" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 font-bold shadow cursor-pointer transition transform active:scale-95">
                    + Agregar
                </button>
            </div>
        </div>
        
        <div id="avisoSabado" class="hidden mb-4 text-blue-600 text-sm font-bold text-center bg-blue-50 p-2 rounded border border-blue-100">
            游늰 S츼BADO DETECTADO: Salida ajustada a las 12:00 PM
        </div>

        <div class="overflow-x-auto mb-6 border rounded-lg shadow-sm">
            <table class="w-full text-sm text-left text-gray-700">
                <thead class="text-xs text-gray-700 uppercase bg-gray-200">
                    <tr>
                        <th class="px-2 py-3">D칤a</th>
                        <th class="px-2 py-3">Entrada</th>
                        <th class="px-2 py-3">Salida</th>
                        <th class="px-2 py-3">Base</th>
                        <th class="px-2 py-3 text-red-600">Perdido</th>
                        <th class="px-2 py-3 text-red-600">Desc.</th>
                        <th class="px-2 py-3 text-blue-600">H. Extra</th>
                        <th class="px-2 py-3 text-green-600">$$ Extra</th>
                        <th class="px-2 py-3 font-bold bg-gray-100">Subtotal</th>
                        <th class="px-2 py-3 text-center">X</th>
                    </tr>
                </thead>
                <tbody id="cuerpoTabla" class="divide-y divide-gray-200"></tbody>
                <tfoot class="bg-gray-100 font-bold border-t-2 border-gray-300 text-sm">
                    <tr>
                        <td colspan="6" class="px-4 py-2 text-right text-gray-600">SUBTOTAL SEMANA:</td>
                        <td class="px-2 py-2 text-blue-700 font-extrabold" id="totalHorasExtra">0.00h</td>
                        <td class="px-2 py-2 text-green-700 font-extrabold" id="totalDineroExtra">$0.00</td>
                        <td class="px-2 py-2 text-gray-800" id="subtotalSemana">$0.00</td>
                        <td></td>
                    </tr>
                    <tr id="rowAdelanto" class="bg-red-50 text-red-700 hidden">
                        <td colspan="8" class="px-4 py-2 text-right font-bold">MENOS ADELANTO:</td>
                        <td class="px-2 py-2 font-bold text-lg" id="displayAdelanto">-$0.00</td>
                        <td></td>
                    </tr>
                    <tr class="bg-gray-200 text-gray-900 border-t border-gray-400">
                        <td colspan="8" class="px-4 py-3 text-right font-extrabold text-base">TOTAL L칈QUIDO A PAGAR:</td>
                        <td class="px-2 py-3 font-extrabold text-xl" id="granTotal">$0.00</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="text-right">
            <button type="button" onclick="generarPDF()" class="bg-red-600 text-white px-6 py-3 rounded shadow hover:bg-red-700 font-bold inline-flex items-center gap-2 cursor-pointer transition hover:scale-105">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Imprimir PDF (Carta)
            </button>
        </div>
    </div>

    <script>
        let registros = [];
        
        // --- CONSTANTES ---
        const AM_INICIO = 7 * 60;   
        const AM_FIN    = 12 * 60;  
        const PM_INICIO = 13 * 60;  
        const PM_FIN    = 16 * 60;  

        // --- UTILIDADES ---
        function timeToMinutes(timeStr) {
            if(!timeStr) return 0;
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }

        function minutesTo12Hour(minutes) {
            let h = Math.floor(minutes / 60);
            let m = minutes % 60;
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12; 
            const mStr = m < 10 ? '0'+m : m;
            return `${h}:${mStr} ${ampm}`;
        }

        function formatDateFull(fechaStr) {
            const [anio, mes, dia] = fechaStr.split('-');
            return `${dia}/${mes}/${anio}`;
        }

        function calcSolapamiento(rangoInicio, rangoFin, zonaInicio, zonaFin) {
            const inicio = Math.max(rangoInicio, zonaInicio);
            const fin = Math.min(rangoFin, zonaFin);
            return Math.max(0, fin - inicio);
        }

        function detectarSabado() {
            const f = document.getElementById('inputFecha').value;
            if(!f) return;
            const [a,m,d] = f.split('-').map(Number);
            const date = new Date(a, m-1, d);
            const esSabado = (date.getDay() === 6);
            
            const aviso = document.getElementById('avisoSabado');
            const salida = document.getElementById('inputSalida');
            
            if(esSabado) {
                aviso.classList.remove('hidden');
                salida.value = "12:00"; 
            } else {
                aviso.classList.add('hidden');
                salida.value = "16:00"; 
            }
        }

        // --- L칍GICA PRINCIPAL ---
        function agregarFila() {
            const elFecha = document.getElementById('inputFecha').value;
            const elEntrada = document.getElementById('inputEntrada').value;
            const elSalida = document.getElementById('inputSalida').value;
            const sueldoBase = parseFloat(document.getElementById('inputSueldo').value);
            const tarifaExtra = parseFloat(document.getElementById('inputTarifaExtra').value);

            if (!elFecha || !elEntrada || !elSalida || isNaN(sueldoBase) || isNaN(tarifaExtra)) {
                alert("Por favor completa los campos.");
                return;
            }

            const [a,m,d] = elFecha.split('-').map(Number);
            const fechaObj = new Date(a, m-1, d);
            const diasArr = ["Domingo", "Lunes", "Martes", "Mi칠rcoles", "Jueves", "Viernes", "S치bado"];
            const nombreDia = diasArr[fechaObj.getDay()];
            const esSabado = (fechaObj.getDay() === 6);

            const minEntrada = timeToMinutes(elEntrada);
            const minSalida = timeToMinutes(elSalida);

            let totalHorasExtra = 0;
            let totalHorasPerdidas = 0;
            let precioHoraNormal = 0;

            if (esSabado) {
                const SABADO_FIN = 12 * 60; 
                let extraAM = (minEntrada < AM_INICIO) ? (AM_INICIO - minEntrada) : 0;
                let extraPM = (minSalida > SABADO_FIN) ? (minSalida - SABADO_FIN) : 0;
                totalHorasExtra = (extraAM + extraPM) / 60;

                let perdidos = 0;
                if (minEntrada > AM_INICIO) perdidos += calcSolapamiento(AM_INICIO, minEntrada, AM_INICIO, SABADO_FIN);
                if (minSalida < SABADO_FIN) perdidos += calcSolapamiento(minSalida, SABADO_FIN, AM_INICIO, SABADO_FIN);
                
                totalHorasPerdidas = perdidos / 60;
                precioHoraNormal = sueldoBase / 5; 
            } else {
                let extraAM = (minEntrada < AM_INICIO) ? (AM_INICIO - minEntrada) : 0;
                let extraPM = (minSalida > PM_FIN) ? (minSalida - PM_FIN) : 0;
                totalHorasExtra = (extraAM + extraPM) / 60;

                let perdidos = 0;
                if (minEntrada > AM_INICIO) {
                    perdidos += calcSolapamiento(AM_INICIO, minEntrada, AM_INICIO, AM_FIN);
                    perdidos += calcSolapamiento(AM_INICIO, minEntrada, PM_INICIO, PM_FIN);
                }
                if (minSalida < PM_FIN) {
                    perdidos += calcSolapamiento(minSalida, PM_FIN, PM_INICIO, PM_FIN);
                    perdidos += calcSolapamiento(minSalida, PM_FIN, AM_INICIO, AM_FIN);
                }
                
                totalHorasPerdidas = perdidos / 60;
                precioHoraNormal = sueldoBase / 8;
            }

            const pagoExtra = totalHorasExtra * tarifaExtra;
            const dineroDescontado = totalHorasPerdidas * precioHoraNormal;
            const subtotalDia = sueldoBase - dineroDescontado + pagoExtra;

            registros.push({
                id: Date.now(),
                nombreDia,
                fechaRaw: elFecha,
                fechaFmt: formatDateFull(elFecha),
                entrada12: minutesTo12Hour(minEntrada),
                salida12: minutesTo12Hour(minSalida),
                sueldoBase,
                horasPerdidas: totalHorasPerdidas.toFixed(2),
                dineroDescontado,
                horasExtra: totalHorasExtra.toFixed(2),
                pagoExtra,
                subtotal: subtotalDia
            });

            renderizarTabla();
        }

        function eliminarFila(id) {
            registros = registros.filter(r => r.id !== id);
            renderizarTabla();
        }

        function renderizarTabla() {
            const tbody = document.getElementById('cuerpoTabla');
            tbody.innerHTML = '';
            
            let sumaSubtotal = 0;
            let sumHorasExtra = 0;
            let sumDineroExtra = 0;

            registros.sort((a, b) => new Date(a.fechaRaw) - new Date(b.fechaRaw));

            registros.forEach(r => {
                sumaSubtotal += r.subtotal;
                sumHorasExtra += parseFloat(r.horasExtra);
                sumDineroExtra += r.pagoExtra;

                const styleDesc = r.dineroDescontado > 0 ? "text-red-600 font-bold" : "text-gray-400";
                const txtDesc = r.dineroDescontado > 0 ? `-$${r.dineroDescontado.toFixed(2)}` : "-";
                const styleExtra = r.pagoExtra > 0 ? "text-green-600 font-bold" : "text-gray-400";
                const txtExtra = r.pagoExtra > 0 ? `+$${r.pagoExtra.toFixed(2)}` : "-";
                const rowClass = (r.nombreDia === "S치bado") ? "bg-blue-50 border-b" : "bg-white border-b";

                const tr = document.createElement('tr');
                tr.className = rowClass;
                tr.innerHTML = `
                    <td class="px-2 py-2">
                        <div class="font-bold text-gray-800">${r.nombreDia}</div>
                        <div class="text-xs text-gray-500">${r.fechaFmt}</div>
                    </td>
                    <td class="px-2 py-2 text-xs md:text-sm">${r.entrada12}</td>
                    <td class="px-2 py-2 text-xs md:text-sm">${r.salida12}</td>
                    <td class="px-2 py-2 text-gray-600">$${r.sueldoBase.toFixed(2)}</td>
                    <td class="px-2 py-2 text-xs text-red-400">${r.horasPerdidas > 0 ? r.horasPerdidas+'h' : '-'}</td>
                    <td class="px-2 py-2 ${styleDesc}">${txtDesc}</td>
                    <td class="px-2 py-2 text-xs text-blue-600 font-bold">${r.horasExtra > 0 ? r.horasExtra+'h' : '-'}</td>
                    <td class="px-2 py-2 ${styleExtra}">${txtExtra}</td>
                    <td class="px-2 py-2 font-bold text-gray-900 border-l">$${r.subtotal.toFixed(2)}</td>
                    <td class="px-2 py-2 text-center">
                        <button onclick="eliminarFila(${r.id})" class="text-red-500 font-bold px-2 hover:bg-red-200 rounded">X</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // C츼LCULOS FINALES
            const adelanto = parseFloat(document.getElementById('inputAdelanto').value) || 0;
            const granTotalLiquido = sumaSubtotal - adelanto;

            document.getElementById('subtotalSemana').innerText = `$${sumaSubtotal.toFixed(2)}`;
            document.getElementById('totalHorasExtra').innerText = `${sumHorasExtra.toFixed(2)}h`;
            document.getElementById('totalDineroExtra').innerText = `+$${sumDineroExtra.toFixed(2)}`;
            
            const rowAdelanto = document.getElementById('rowAdelanto');
            const displayAdelanto = document.getElementById('displayAdelanto');
            if (adelanto > 0) {
                rowAdelanto.classList.remove('hidden');
                displayAdelanto.innerText = `-$${adelanto.toFixed(2)}`;
            } else {
                rowAdelanto.classList.add('hidden');
            }

            document.getElementById('granTotal').innerText = `$${granTotalLiquido.toFixed(2)}`;
        }

        async function generarPDF() {
            if (registros.length === 0) { alert("No hay datos"); return; }
            
            const nombre = document.getElementById('inputNombre').value || "TRABAJADOR";
            const tarifa = document.getElementById('inputTarifaExtra').value;
            const adelanto = parseFloat(document.getElementById('inputAdelanto').value) || 0;
            const fechaGeneracion = new Date().toLocaleString('es-ES');

            const { jsPDF } = window.jspdf;
            // TAMA칌O CARTA (LETTER)
            const doc = new jsPDF('l', 'mm', 'letter'); // Altura ~216mm

            doc.setFontSize(14);
            doc.text("REPORTE DE TRABAJO", 14, 15);
            doc.setFontSize(9);
            doc.setTextColor(100);
            doc.text(`Generado: ${fechaGeneracion}`, 260, 15, { align: 'right' });
            
            doc.setTextColor(0);
            doc.text(`Trabajador: ${nombre.toUpperCase()}`, 14, 23);
            doc.text(`Tarifa Extra: $${tarifa}/h`, 14, 27);
            doc.setFontSize(8);
            doc.text("Lunes-Viernes (7am-4pm) | S치bados (7am-12pm)", 14, 32);

            const headers = [["D칤a / Fecha", "Entrada", "Salida", "Base", "H.Perd", "Desc.", "H.Ext", "$ Extra", "Subtotal"]];
            
            const data = registros.map(r => [
                `${r.nombreDia}\n${r.fechaFmt}`,
                r.entrada12,
                r.salida12,
                `$${r.sueldoBase.toFixed(2)}`,
                r.horasPerdidas > 0 ? `${r.horasPerdidas}h` : "-",
                r.dineroDescontado > 0 ? `-$${r.dineroDescontado.toFixed(2)}` : "-",
                r.horasExtra > 0 ? `${r.horasExtra}h` : "-",
                `$${r.pagoExtra.toFixed(2)}`,
                `$${r.subtotal.toFixed(2)}`
            ]);

            // TOTALES
            const sumBase = registros.reduce((a, b) => a + b.sueldoBase, 0);
            const sumDesc = registros.reduce((a, b) => a + b.dineroDescontado, 0);
            const sumHorasExt = registros.reduce((a, b) => a + parseFloat(b.horasExtra), 0); 
            const sumDineroExt = registros.reduce((a, b) => a + b.pagoExtra, 0);
            const sumSubtotal  = registros.reduce((a, b) => a + b.subtotal, 0);
            const totalLiquido = sumSubtotal - adelanto;

            data.push([
                "SUMA SEMANA", "", "", 
                `$${sumBase.toFixed(2)}`, 
                "", 
                `-$${sumDesc.toFixed(2)}`, 
                `${sumHorasExt.toFixed(2)} h`,
                `+$${sumDineroExt.toFixed(2)}`, 
                `$${sumSubtotal.toFixed(2)}`
            ]);

            if (adelanto > 0) {
                data.push(["MENOS ADELANTO", "", "", "", "", "", "", "", `-$${adelanto.toFixed(2)}`]);
            }

            data.push(["PAGO TOTAL", "", "", "", "", "", "", "", `$${totalLiquido.toFixed(2)}`]);

            doc.autoTable({
                head: headers,
                body: data,
                startY: 36,
                theme: 'striped',
                styles: { fontSize: 9, cellPadding: 2, valign: 'middle', halign: 'center' },
                columnStyles: {
                    0: { halign: 'left', fontStyle: 'bold' },
                    5: { textColor: [200, 0, 0] }, 
                    6: { fontStyle: 'bold', textColor: [0, 80, 200] },
                    7: { textColor: [0, 100, 0] }, 
                    8: { fontStyle: 'bold' }
                },
                didParseCell: function (data) {
                    const rowCount = data.table.body.length;
                    if (data.row.index === rowCount - 1) { // Fila Total Final
                        data.cell.styles.fillColor = [50, 50, 50];
                        data.cell.styles.textColor = [255, 255, 255];
                        data.cell.styles.fontStyle = 'bold';
                    }
                }
            });

            // --- L칍GICA DE FIRMA COMPACTA ---
            // Reducimos el espacio vertical a solo 15mm (antes 35)
            let finalY = doc.lastAutoTable.finalY + 15;
            
            // Si nos pasamos de 190mm (Letter mide 216mm), pasamos a otra hoja
            if (finalY > 190) { 
                doc.addPage(); 
                finalY = 40; 
            }
            
            const pageWidth = doc.internal.pageSize.getWidth();
            doc.setLineWidth(0.5);
            
            // L칤nea m치s corta (60mm de ancho total)
            doc.line(pageWidth / 2 - 30, finalY, pageWidth / 2 + 30, finalY);
            
            // Texto m치s peque침o
            doc.setFontSize(10);
            doc.setTextColor(0);
            doc.text(nombre.toUpperCase(), pageWidth / 2, finalY + 5, { align: 'center' });
            
            doc.setFontSize(8);
            doc.text("Firma del Trabajador", pageWidth / 2, finalY + 10, { align: 'center' });

            doc.save(`Nomina_${nombre.replace(/\s+/g, '_')}.pdf`);
        }
        
        document.getElementById('inputFecha').valueAsDate = new Date();
        detectarSabado();
    </script>
</body>
</html>
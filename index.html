<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N칩mina Final - S치bados Mediod칤a</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 shadow-lg rounded-lg">
        
        <div class="border-b pb-4 mb-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Control de N칩mina</h1>
                <p class="text-gray-500 text-sm">Lunes-Viernes (7-4) | <span class="text-blue-600 font-bold">S치bados (7-12)</span></p>
            </div>
            <div class="text-right flex flex-col items-end gap-1">
                <div class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded text-xs font-bold border border-yellow-200">
                    Almuerzo (L-V): 12:00 - 01:00
                </div>
                <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded text-xs font-bold border border-blue-200">
                    S치bados: Salida 12:00 PM
                </div>
            </div>
        </div>

        <div class="mb-6 bg-blue-50 p-4 rounded border border-blue-200 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
                <label class="block text-gray-700 font-bold mb-2">Nombre del Trabajador:</label>
                <input type="text" id="inputNombre" class="w-full border border-gray-300 p-2 rounded text-lg uppercase" placeholder="Ej: JUAN P칄REZ">
            </div>
            <div>
                <label class="block text-gray-700 font-bold mb-2">Pago Hora Extra ($):</label>
                <input type="number" id="inputTarifaExtra" class="w-full border border-gray-300 p-2 rounded text-lg font-bold text-green-700" value="3.00" step="0.50">
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-6 items-end bg-gray-50 p-4 rounded border">
            <div class="col-span-1 md:col-span-2">
                <label class="block text-xs font-bold mb-1">Fecha (D칤a/Mes/A침o)</label>
                <input type="date" id="inputFecha" class="w-full border p-2 rounded" onchange="detectarSabado()">
            </div>
            <div>
                <label class="block text-xs font-bold mb-1">Entrada</label>
                <input type="time" id="inputEntrada" class="w-full border p-2 rounded" value="07:00">
            </div>
            <div>
                <label class="block text-xs font-bold mb-1">Salida</label>
                <input type="time" id="inputSalida" class="w-full border p-2 rounded" value="16:00">
            </div>
            <div>
                <label class="block text-xs font-bold mb-1">Sueldo Diario ($)</label>
                <input type="number" id="inputSueldo" class="w-full border p-2 rounded" placeholder="20" value="20">
            </div>
            <div>
                <button type="button" onclick="agregarFila()" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 font-bold shadow cursor-pointer transition transform active:scale-95">
                    + Calcular
                </button>
            </div>
        </div>
        <div id="avisoSabado" class="hidden mb-4 text-blue-600 text-sm font-bold text-center bg-blue-50 p-2 rounded">
            游늰 Fecha detectada como S츼BADO: Horario ajustado a 7:00 AM - 12:00 PM
        </div>

        <div class="overflow-x-auto mb-6 border rounded-lg shadow-sm">
            <table class="w-full text-sm text-left text-gray-700">
                <thead class="text-xs text-gray-700 uppercase bg-gray-200">
                    <tr>
                        <th class="px-2 py-3">D칤a</th>
                        <th class="px-2 py-3">Entrada</th>
                        <th class="px-2 py-3">Salida</th>
                        <th class="px-2 py-3">Base</th>
                        <th class="px-2 py-3 text-red-600">Perdido</th>
                        <th class="px-2 py-3 text-red-600">Desc.</th>
                        <th class="px-2 py-3 text-blue-600">Extra</th>
                        <th class="px-2 py-3 text-green-600">$$ Extra</th>
                        <th class="px-2 py-3 font-bold bg-gray-100">Total</th>
                        <th class="px-2 py-3 text-center">X</th>
                    </tr>
                </thead>
                <tbody id="cuerpoTabla" class="divide-y divide-gray-200"></tbody>
                <tfoot class="bg-gray-100 font-bold border-t-2 border-gray-300">
                    <tr>
                        <td colspan="8" class="px-4 py-3 text-right text-gray-600">TOTAL NETO A PAGAR:</td>
                        <td colspan="2" class="px-4 py-3 text-xl text-blue-800" id="granTotal">$0.00</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="text-right">
            <button type="button" onclick="generarPDF()" class="bg-red-600 text-white px-6 py-3 rounded shadow hover:bg-red-700 font-bold inline-flex items-center gap-2 cursor-pointer transition hover:scale-105">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Descargar Reporte PDF
            </button>
        </div>
    </div>

    <script>
        let registros = [];
        
        // --- CONSTANTES GLOBALES (Minutos) ---
        const AM_INICIO = 7 * 60;   // 07:00 (420)
        const AM_FIN    = 12 * 60;  // 12:00 (720)
        
        // L-V
        const PM_INICIO = 13 * 60;  // 01:00 (780)
        const PM_FIN    = 16 * 60;  // 04:00 (960)

        // --- UTILIDADES ---
        function timeToMinutes(timeStr) {
            if(!timeStr) return 0;
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }

        function minutesTo12Hour(minutes) {
            let h = Math.floor(minutes / 60);
            let m = minutes % 60;
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12; 
            const mStr = m < 10 ? '0'+m : m;
            return `${h}:${mStr} ${ampm}`;
        }

        function formatDateFull(fechaStr) {
            const [anio, mes, dia] = fechaStr.split('-');
            return `${dia}/${mes}/${anio}`;
        }

        function calcSolapamiento(rangoInicio, rangoFin, zonaInicio, zonaFin) {
            const inicio = Math.max(rangoInicio, zonaInicio);
            const fin = Math.min(rangoFin, zonaFin);
            return Math.max(0, fin - inicio);
        }

        // --- DETECTAR S츼BADO ---
        function detectarSabado() {
            const fechaVal = document.getElementById('inputFecha').value;
            if(!fechaVal) return;
            const [a,m,d] = fechaVal.split('-').map(Number);
            const fecha = new Date(a, m-1, d);
            const esSabado = (fecha.getDay() === 6);
            
            const aviso = document.getElementById('avisoSabado');
            if(esSabado) {
                aviso.classList.remove('hidden');
                document.getElementById('inputSalida').value = "12:00"; // Sugerir salida 12:00
            } else {
                aviso.classList.add('hidden');
                document.getElementById('inputSalida').value = "16:00"; // Sugerir salida 16:00
            }
        }

        // --- L칍GICA PRINCIPAL ---
        function agregarFila() {
            const elFecha = document.getElementById('inputFecha').value;
            const elEntrada = document.getElementById('inputEntrada').value;
            const elSalida = document.getElementById('inputSalida').value;
            const sueldoBase = parseFloat(document.getElementById('inputSueldo').value);
            const tarifaExtra = parseFloat(document.getElementById('inputTarifaExtra').value);

            if (!elFecha || !elEntrada || !elSalida || isNaN(sueldoBase) || isNaN(tarifaExtra)) {
                alert("Por favor completa los campos.");
                return;
            }

            // 1. Determinar si es S치bado
            const [a,m,d] = elFecha.split('-').map(Number);
            const fechaObj = new Date(a, m-1, d);
            const diasArr = ["Domingo", "Lunes", "Martes", "Mi칠rcoles", "Jueves", "Viernes", "S치bado"];
            const nombreDia = diasArr[fechaObj.getDay()];
            const esSabado = (fechaObj.getDay() === 6);

            const minEntrada = timeToMinutes(elEntrada);
            const minSalida = timeToMinutes(elSalida);

            let totalHorasExtra = 0;
            let totalHorasPerdidas = 0;
            let precioHoraNormal = 0;

            // --- L칍GICA DIFERENCIADA ---
            if (esSabado) {
                // === L칍GICA S츼BADO (7am - 12pm) ===
                const SABADO_FIN = 12 * 60; // 12:00 PM
                const HORAS_JORNADA_SABADO = 5; // De 7 a 12 son 5 horas

                // A. Extras S치bado
                // Antes de las 7am
                let extraAM = 0;
                if (minEntrada < AM_INICIO) extraAM = AM_INICIO - minEntrada;
                
                // Despu칠s de las 12pm
                let extraPM = 0;
                if (minSalida > SABADO_FIN) extraPM = minSalida - SABADO_FIN;
                
                totalHorasExtra = (extraAM + extraPM) / 60;

                // B. Descuentos S치bado (Huecos entre 7am y 12pm)
                // Se descuenta si llega tarde o se va antes de las 12
                let minutosPerdidos = 0;
                
                // Llegada tard칤a
                if (minEntrada > AM_INICIO) {
                    minutosPerdidos += calcSolapamiento(AM_INICIO, minEntrada, AM_INICIO, SABADO_FIN);
                }
                // Salida anticipada
                if (minSalida < SABADO_FIN) {
                    minutosPerdidos += calcSolapamiento(minSalida, SABADO_FIN, AM_INICIO, SABADO_FIN);
                }

                totalHorasPerdidas = minutosPerdidos / 60;
                
                // PRECIO HORA S츼BADO: SueldoBase / 5
                // (Porque ganan el d칤a completo trabajando solo 5 horas)
                precioHoraNormal = sueldoBase / HORAS_JORNADA_SABADO;

            } else {
                // === L칍GICA LUNES-VIERNES (7-12, 1-4) ===
                const HORAS_JORNADA_LV = 8;

                // A. Extras L-V
                let extraAM = 0;
                if (minEntrada < AM_INICIO) extraAM = AM_INICIO - minEntrada;
                
                let extraPM = 0;
                if (minSalida > PM_FIN) extraPM = minSalida - PM_FIN;
                
                totalHorasExtra = (extraAM + extraPM) / 60;

                // B. Descuentos L-V (Excluye almuerzo 12-1)
                let minutosPerdidos = 0;

                if (minEntrada > AM_INICIO) {
                    minutosPerdidos += calcSolapamiento(AM_INICIO, minEntrada, AM_INICIO, AM_FIN);
                    minutosPerdidos += calcSolapamiento(AM_INICIO, minEntrada, PM_INICIO, PM_FIN);
                }

                if (minSalida < PM_FIN) {
                    minutosPerdidos += calcSolapamiento(minSalida, PM_FIN, PM_INICIO, PM_FIN);
                    minutosPerdidos += calcSolapamiento(minSalida, PM_FIN, AM_INICIO, AM_FIN);
                }

                totalHorasPerdidas = minutosPerdidos / 60;
                
                // PRECIO HORA L-V: SueldoBase / 8
                precioHoraNormal = sueldoBase / HORAS_JORNADA_LV;
            }

            // --- C츼LCULOS FINALES ---
            const pagoExtra = totalHorasExtra * tarifaExtra;
            const dineroDescontado = totalHorasPerdidas * precioHoraNormal;
            const totalDia = sueldoBase - dineroDescontado + pagoExtra;

            registros.push({
                id: Date.now(),
                nombreDia,
                fechaRaw: elFecha,
                fechaFmt: formatDateFull(elFecha),
                entrada12: minutesTo12Hour(minEntrada),
                salida12: minutesTo12Hour(minSalida),
                sueldoBase,
                horasPerdidas: totalHorasPerdidas.toFixed(2),
                dineroDescontado,
                horasExtra: totalHorasExtra.toFixed(2),
                pagoExtra,
                total: totalDia
            });

            renderizarTabla();
        }

        function eliminarFila(id) {
            registros = registros.filter(r => r.id !== id);
            renderizarTabla();
        }

        function renderizarTabla() {
            const tbody = document.getElementById('cuerpoTabla');
            tbody.innerHTML = '';
            let sumaTotal = 0;

            registros.sort((a, b) => new Date(a.fechaRaw) - new Date(b.fechaRaw));

            registros.forEach(r => {
                sumaTotal += r.total;
                
                const styleDesc = r.dineroDescontado > 0 ? "text-red-600 font-bold" : "text-gray-400";
                const txtDesc = r.dineroDescontado > 0 ? `-$${r.dineroDescontado.toFixed(2)}` : "-";
                
                const styleExtra = r.pagoExtra > 0 ? "text-green-600 font-bold" : "text-gray-400";
                const txtExtra = r.pagoExtra > 0 ? `+$${r.pagoExtra.toFixed(2)}` : "-";

                // Resaltar si es S치bado
                const esSab = r.nombreDia === "S치bado";
                const rowClass = esSab ? "bg-blue-50 border-b hover:bg-blue-100" : "bg-white border-b hover:bg-gray-50";

                const tr = document.createElement('tr');
                tr.className = rowClass;
                tr.innerHTML = `
                    <td class="px-2 py-2">
                        <div class="font-bold text-gray-800">${r.nombreDia}</div>
                        <div class="text-xs text-gray-500">${r.fechaFmt}</div>
                    </td>
                    <td class="px-2 py-2 text-xs md:text-sm">${r.entrada12}</td>
                    <td class="px-2 py-2 text-xs md:text-sm">${r.salida12}</td>
                    <td class="px-2 py-2 text-gray-600">$${r.sueldoBase.toFixed(2)}</td>
                    <td class="px-2 py-2 text-xs text-red-400">${r.horasPerdidas > 0 ? r.horasPerdidas+'h' : '-'}</td>
                    <td class="px-2 py-2 ${styleDesc}">${txtDesc}</td>
                    <td class="px-2 py-2 text-xs text-blue-500">${r.horasExtra > 0 ? r.horasExtra+'h' : '-'}</td>
                    <td class="px-2 py-2 ${styleExtra}">${txtExtra}</td>
                    <td class="px-2 py-2 font-bold text-gray-900 border-l">$${r.total.toFixed(2)}</td>
                    <td class="px-2 py-2 text-center">
                        <button onclick="eliminarFila(${r.id})" class="text-red-500 font-bold px-2 hover:bg-red-200 rounded">X</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('granTotal').innerText = `$${sumaTotal.toFixed(2)}`;
        }

        async function generarPDF() {
            if (registros.length === 0) { alert("No hay datos"); return; }
            
            const nombre = document.getElementById('inputNombre').value || "TRABAJADOR";
            const tarifa = document.getElementById('inputTarifaExtra').value;
            const fechaGeneracion = new Date().toLocaleString('es-ES');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4');

            doc.setFontSize(16);
            doc.text("REPORTE DE HORAS TRABAJADAS", 14, 15);
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Generado el: ${fechaGeneracion}`, 280, 15, { align: 'right' });
            
            doc.setTextColor(0);
            doc.text(`Trabajador: ${nombre.toUpperCase()}`, 14, 25);
            doc.text(`Tarifa Extra: $${tarifa}/h`, 14, 30);
            doc.setFontSize(9);
            doc.text("Horarios: Lunes-Viernes (7am-4pm) | S치bados (7am-12pm)", 14, 35);

            const headers = [["D칤a / Fecha", "Entrada", "Salida", "Base", "H.Perd", "Desc.", "H.Ext", "$ Extra", "TOTAL"]];
            
            const data = registros.map(r => [
                `${r.nombreDia}\n${r.fechaFmt}`,
                r.entrada12,
                r.salida12,
                `$${r.sueldoBase.toFixed(2)}`,
                r.horasPerdidas > 0 ? `${r.horasPerdidas}h` : "-",
                r.dineroDescontado > 0 ? `-$${r.dineroDescontado.toFixed(2)}` : "-",
                r.horasExtra > 0 ? `${r.horasExtra}h` : "-",
                `$${r.pagoExtra.toFixed(2)}`,
                `$${r.total.toFixed(2)}`
            ]);

            const sumBase = registros.reduce((a, b) => a + b.sueldoBase, 0);
            const sumDesc = registros.reduce((a, b) => a + b.dineroDescontado, 0);
            const sumExtr = registros.reduce((a, b) => a + b.pagoExtra, 0);
            const sumTot  = registros.reduce((a, b) => a + b.total, 0);

            data.push([
                "TOTALES", "", "", 
                `$${sumBase.toFixed(2)}`, 
                "", 
                `-$${sumDesc.toFixed(2)}`, 
                "", 
                `+$${sumExtr.toFixed(2)}`, 
                `$${sumTot.toFixed(2)}`
            ]);

            doc.autoTable({
                head: headers,
                body: data,
                startY: 40,
                theme: 'striped',
                styles: { fontSize: 10, cellPadding: 3, valign: 'middle', halign: 'center' },
                columnStyles: {
                    0: { halign: 'left', fontStyle: 'bold' },
                    5: { textColor: [200, 0, 0] },
                    7: { textColor: [0, 100, 0] },
                    8: { fontStyle: 'bold', fillColor: [240, 240, 240] }
                },
                didParseCell: function (data) {
                    if (data.row.index === registros.length) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [50, 50, 50];
                        data.cell.styles.textColor = [255, 255, 255];
                    }
                }
            });

            // FIRMA
            let finalY = doc.lastAutoTable.finalY + 35;
            if (finalY > 180) { doc.addPage(); finalY = 50; }
            const pageWidth = doc.internal.pageSize.getWidth();
            doc.setLineWidth(0.5);
            doc.line(pageWidth / 2 - 40, finalY, pageWidth / 2 + 40, finalY);
            
            doc.setFontSize(11);
            doc.setTextColor(0);
            doc.text(nombre.toUpperCase(), pageWidth / 2, finalY + 6, { align: 'center' });
            doc.text("Firma del Trabajador", pageWidth / 2, finalY + 12, { align: 'center' });

            doc.save(`Nomina_${nombre.replace(/\s+/g, '_')}.pdf`);
        }
        
        // Inicializar
        document.getElementById('inputFecha').valueAsDate = new Date();
        detectarSabado(); // Chequear fecha inicial
    </script>
</body>
</html>